

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 




      <title>å¦‚ä½•ç”¨DETRå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›† - Ashhhi</title>

  <meta name="description" content="DETRä½œä¸ºTransformeråœ¨ç›®æ ‡æ£€æµ‹ä¸­çš„å¼€å±±ä¹‹ä½œï¼Œå½±å“åŠ›è‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œå¹¶ä¸”å®˜æ–¹å·²ç»å¼€æºäº†ä»£ç ï¼Œå› æ­¤æœ€å¥½çš„å­¦ä¹ æ–¹å¼ä¾¿æ˜¯åˆ©ç”¨è®ºæ–‡å’Œä»£ç è¿›è¡Œå®è·µï¼Œè®ºæ–‡åœ°å€å’ŒGithubä»£ç é“¾æ¥é™„ä¸Šï¼š">
  <meta name="author" content="Ashhhi"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Ashhhi - æ‚è®°",
    
    "url": "http:\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "http:\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "http:\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "http:\/\/localhost:1313\/post\/2024-09-06-detr\/",
          "name": "å¦‚ä½•ç”¨ detrå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Ashhhi"
  },
  "headline": "å¦‚ä½•ç”¨DETRå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†",
  "description" : "DETRä½œä¸ºTransformeråœ¨ç›®æ ‡æ£€æµ‹ä¸­çš„å¼€å±±ä¹‹ä½œï¼Œå½±å“åŠ›è‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œå¹¶ä¸”å®˜æ–¹å·²ç»å¼€æºäº†ä»£ç ï¼Œå› æ­¤æœ€å¥½çš„å­¦ä¹ æ–¹å¼ä¾¿æ˜¯åˆ©ç”¨è®ºæ–‡å’Œä»£ç è¿›è¡Œå®è·µï¼Œè®ºæ–‡åœ°å€å’ŒGithubä»£ç é“¾æ¥é™„ä¸Šï¼š\n",
  "inLanguage" : "en",
  "wordCount":  5198 ,
  "datePublished" : "2024-09-06T00:00:00\u002b00:00",
  "dateModified" : "2024-09-06T00:00:00\u002b00:00",
  "image" : "http:\/\/localhost:1313\/img\/avatar.jpg",
  "keywords" : [ "Deep Learning, Computer Vision" ],
  "mainEntityOfPage" : "http:\/\/localhost:1313\/post\/2024-09-06-detr\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "http:\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "http:\/\/localhost:1313\/img\/avatar.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="å¦‚ä½•ç”¨DETRå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†" />
<meta property="og:description" content="DETRä½œä¸ºTransformeråœ¨ç›®æ ‡æ£€æµ‹ä¸­çš„å¼€å±±ä¹‹ä½œï¼Œå½±å“åŠ›è‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œå¹¶ä¸”å®˜æ–¹å·²ç»å¼€æºäº†ä»£ç ï¼Œå› æ­¤æœ€å¥½çš„å­¦ä¹ æ–¹å¼ä¾¿æ˜¯åˆ©ç”¨è®ºæ–‡å’Œä»£ç è¿›è¡Œå®è·µï¼Œè®ºæ–‡åœ°å€å’ŒGithubä»£ç é“¾æ¥é™„ä¸Šï¼š">
<meta property="og:image" content="http://localhost:1313/img/avatar.jpg" />
<meta property="og:url" content="http://localhost:1313/post/2024-09-06-detr/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Ashhhi - æ‚è®°" />

  <meta name="twitter:title" content="å¦‚ä½•ç”¨DETRå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†" />
  <meta name="twitter:description" content="DETRä½œä¸ºTransformeråœ¨ç›®æ ‡æ£€æµ‹ä¸­çš„å¼€å±±ä¹‹ä½œï¼Œå½±å“åŠ›è‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œå¹¶ä¸”å®˜æ–¹å·²ç»å¼€æºäº†ä»£ç ï¼Œå› æ­¤æœ€å¥½çš„å­¦ä¹ æ–¹å¼ä¾¿æ˜¯åˆ©ç”¨è®ºæ–‡å’Œä»£ç è¿›è¡Œå®è·µï¼Œè®ºæ–‡åœ°å€å’ŒGithubä»£ç é“¾æ¥é™„ä¸Šï¼š">
  <meta name="twitter:image" content="http://localhost:1313/img/avatar.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  
  <link
  rel="icon"
  type="image/svg+xml"
  href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¥”</text></svg>"
/>
  <meta name="generator" content="Hugo 0.134.2">
  <link rel="alternate" href="http://localhost:1313/index.xml" type="application/rss+xml" title="Ashhhi - æ‚è®°"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="http://localhost:1313/css/main-nodark.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://localhost:1313/css/highlight.min.css" /><link rel="stylesheet" href="http://localhost:1313/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">




  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://localhost:1313/">Ashhhi - æ‚è®°</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Ashhhi - æ‚è®°" href="http://localhost:1313/">
            <img class="avatar-img" src="http://localhost:1313/img/avatar.jpg" alt="Ashhhi - æ‚è®°" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>å¦‚ä½•ç”¨DETRå®˜æ–¹ä»£ç è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on September 6, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;11&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;5198&nbsp;words
  
  

  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      
      
        
          <nav id="TableOfContents">
  <ul>
    <li><a href="#1-ä»£ç ç»“æ„">1. ä»£ç ç»“æ„</a></li>
    <li><a href="#2-æ„å»ºè‡ªå·±çš„æ•°æ®é›†">2. æ„å»ºè‡ªå·±çš„æ•°æ®é›†</a>
      <ul>
        <li><a href="#21-roboflowæ ‡æ³¨">2.1 Roboflowæ ‡æ³¨</a></li>
        <li><a href="#22-è‡ªå®šä¹‰datasetç±»pytorch">2.2 è‡ªå®šä¹‰Datasetç±»ï¼ˆPyTorchï¼‰</a></li>
        <li><a href="#23-æ•°æ®å¢å¼ºéƒ¨åˆ†">2.3 æ•°æ®å¢å¼ºéƒ¨åˆ†</a></li>
      </ul>
    </li>
    <li><a href="#3-å¼€å§‹è®­ç»ƒ">3. å¼€å§‹è®­ç»ƒ</a>
      <ul>
        <li><a href="#31-æ¨¡å‹å‚æ•°è®¾ç½®">3.1 æ¨¡å‹å‚æ•°è®¾ç½®</a></li>
        <li><a href="#32-åŠ è½½é¢„è®­ç»ƒæƒé‡ç„¶åå¾®è°ƒ">3.2 åŠ è½½é¢„è®­ç»ƒæƒé‡ç„¶åå¾®è°ƒ</a></li>
      </ul>
    </li>
    <li><a href="#4-å¯è§†åŒ–æµ‹è¯•ç»“æœ">4. å¯è§†åŒ–æµ‹è¯•ç»“æœ</a></li>
    <li><a href="#5-æ€»ç»“">5. æ€»ç»“</a></li>
  </ul>
</nav> 
        
      


      <article role="main" class="blog-post">
        <p>DETRä½œä¸ºTransformeråœ¨ç›®æ ‡æ£€æµ‹ä¸­çš„å¼€å±±ä¹‹ä½œï¼Œå½±å“åŠ›è‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œå¹¶ä¸”å®˜æ–¹å·²ç»å¼€æºäº†ä»£ç ï¼Œå› æ­¤æœ€å¥½çš„å­¦ä¹ æ–¹å¼ä¾¿æ˜¯åˆ©ç”¨è®ºæ–‡å’Œä»£ç è¿›è¡Œå®è·µï¼Œè®ºæ–‡åœ°å€å’ŒGithubä»£ç é“¾æ¥é™„ä¸Šï¼š</p>
<p>â€‹
è®ºæ–‡åœ°å€ï¼š<a href="https://arxiv.org/abs/2005.12872">https://arxiv.org/abs/2005.12872</a></p>
<p>Githubåœ°å€ï¼š<a href="https://github.com/facebookresearch/detr">https://github.com/facebookresearch/detr</a></p>
<p>å…³äºæ¨¡å‹åŸç†ç½‘ä¸Šå·²ç»æœ‰å„ä¸ªå¤§ä½¬çš„è®²è§£äº†ï¼Œè¿™é‡Œæ”¾ä¸Šæˆ‘è§‰å¾—è®²çš„æœ€æ¸…æ™°çš„ï¼š
<a href="https://blog.csdn.net/baidu_36913330/article/details/120495817">æ·±åº¦å­¦ä¹ ä¹‹ç›®æ ‡æ£€æµ‹ï¼ˆåä¸€ï¼‰&ndash;DETRè¯¦è§£</a></p>
<hr>
<p><code>æç¤ºï¼šä»…ä¾›å‚è€ƒï¼Œå…·ä½“å‘½ä»¤è¡Œæˆ–ä»£ç æŒ‰éœ€æ‰§è¡Œ</code></p>
<h1 id="1-ä»£ç ç»“æ„">1. ä»£ç ç»“æ„</h1>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆCloneä¸‹æ¥ä»£ç ï¼Œä»£ç çš„ç»“æ„å¹¶ä¸å¤æ‚ï¼Œåªæœ‰å‡ ä¸ªæ–‡ä»¶å¤¹ï¼š</p>
<ul>
<li>datasetsï¼šæºç æ˜¯ä½¿ç”¨<a href="http://cocodataset.org">COCO2017</a>ä½œä¸ºåŸºç¡€æ•°æ®é›†çš„ï¼Œå› æ­¤è¿™é‡Œé¢åŒ…å«æœ‰COCOçš„Datasetç±»ä»¥åŠç”¨äºæ•°æ®å¢å¼ºçš„transforms.pyæ–‡ä»¶ã€‚</li>
<li>modelsï¼šè¯¥æ–‡ä»¶å¤¹ä¸‹å­˜å‚¨äº†DETRæ¨¡å‹çš„åŸºç¡€ç»“æ„ï¼ŒåŒ…æ‹¬Transformeræ¨¡å—å’Œä¸»å¹²ç½‘ç»œç­‰ç­‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä¸ç”¨å»ä¿®æ”¹å®ƒã€‚</li>
<li>utilsï¼šè¯¥æ–‡ä»¶å¤¹ä¸‹å­˜å‚¨çš„éƒ½æ˜¯ä¸€äº›æ‚ä¸ƒæ‚å…«çš„å·¥å…·ç±»ï¼Œä¹Ÿä¸ç”¨å»ä¿®æ”¹å®ƒã€‚</li>
</ul>
<p>é‡ç‚¹æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>main.pyï¼šè¿™æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œè¿™ä¸ªæ–‡ä»¶æ¥è®¾ç½®å„ç§è¶…å‚æ•°ä»¥åŠè¿›å…¥è®­ç»ƒï¼ŒéªŒè¯çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯engine.pyã€‚</li>
<li>engine.pyï¼šè¿™æ˜¯â€œå¼•æ“â€æ–‡ä»¶ï¼Œè¯´ç™½äº†å°±æ˜¯ä»mainæ–‡ä»¶ä¼šè°ƒç”¨é‡Œé¢çš„å‡½æ•°å»è¿›è¡Œè®­ç»ƒå’ŒéªŒè¯ã€‚</li>
<li>datasets/transforms.pyï¼šè¿™æ˜¯æ•°æ®å¢å¼ºçš„éƒ¨åˆ†ï¼Œæœ‰å¾ˆé•¿æ—¶é—´æˆ‘ä¸€ç›´æ²¡æœ‰è®­ç»ƒå‡ºå¥½çš„ç»“æœï¼Œåœ¨çœ‹äº†è¿™é‡Œçš„ä»£ç æ‰çŸ¥é“æ˜¯è‡ªå·±çš„æ•°æ®æ ¼å¼å‡ºäº†é—®é¢˜ï¼Œå› æ­¤åé¢ä¹Ÿä¼šè®²ä¸€ä¸‹ã€‚</li>
</ul>
<h1 id="2-æ„å»ºè‡ªå·±çš„æ•°æ®é›†">2. æ„å»ºè‡ªå·±çš„æ•°æ®é›†</h1>
<p>COCOæ•°æ®é›†å¯ä»¥ç›´æ¥é‡‡ç”¨å®˜æ–¹çš„å®ç°æ–¹æ³•ï¼Œåœ¨Githubé‡Œä¹Ÿæœ‰å¯¹åº”çš„Tutorialï¼Œè¿™é‡Œæˆ‘ä»¬è®²ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†è¿›è¡Œè®­ç»ƒã€‚</p>
<h2 id="21-roboflowæ ‡æ³¨">2.1 Roboflowæ ‡æ³¨</h2>
<p>é¦–å…ˆæ˜¯æ•°æ®æ ‡æ³¨éƒ¨åˆ†ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯<a href="https://roboflow.com/">Roboflow</a>å¹³å°è¿›è¡Œæ ‡æ³¨ï¼Œæ ‡æ³¨å®Œæˆåé€‰æ‹©å¯¼å‡ºæ ¼å¼ä¸ºCOCOæ•°æ®é›†æ ¼å¼ï¼Œé€‰æ‹©â€œDownload zip to computerâ€ï¼Œç„¶ååœ¨è‡ªå·±ç”µè„‘ä¸Šè¿›è¡Œå‹ç¼©ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™æ ·æ ¼å¼çš„æ–‡ä»¶ï¼Œåˆ†äº†trainï¼Œvalidï¼Œtestæ–‡ä»¶å¤¹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹å­˜å‚¨äº†å¯¹åº”çš„å›¾ç‰‡è¿˜æœ‰ä¸€ä¸ªjsonæ–‡ä»¶ï¼Œjsonæ–‡ä»¶é‡ŒåŒ…å«äº†æ‰€æœ‰æ ‡ç­¾çš„ä¿¡æ¯ã€‚
<img src="/img/detr_dataset.png" alt=""></p>
<h2 id="22-è‡ªå®šä¹‰datasetç±»pytorch">2.2 è‡ªå®šä¹‰Datasetç±»ï¼ˆPyTorchï¼‰</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦æŠŠæ•°æ®å–‚å…¥ç¥ç»ç½‘ç»œï¼Œå®˜æ–¹ä»£ç æ˜¯ç”¨PyTorchå®ç°çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦è‡ªå·±å®ç°è‡ªå·±æ•°æ®é›†çš„Datasetç±»ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„pyæ–‡ä»¶ï¼Œæ”¾åœ¨datasetsæ–‡ä»¶å¤¹ä¸‹é¢ã€‚è¿™é‡Œæ”¾ä¸Šæˆ‘çš„ä»£ç ï¼Œå¾ˆåŸºç¡€çš„ç»§æ‰¿torch.utils.data.Datasetç±»çš„å†™æ³•ï¼Œä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œé‡è¦çš„éƒ¨åˆ†æˆ‘å·²ç»æ³¨é‡Šå‡ºæ¥äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SmartFarm</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_cls</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="s1">&#39;set must be one of train, valid, test&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">		å®˜æ–¹åŸä»£ç é‡Œæ˜¯ç”¨çš„valä»£è¡¨validï¼Œä½†æ˜¯roboflowç”Ÿæˆçš„æ–‡ä»¶å¤¹å«validï¼Œå¯ä»¥æ”¹ç›´æ¥æ”¹æ–‡ä»¶åï¼Œæˆ‘è¿™æ ·å†™æ˜¯ä¸ºäº†æ–¹ä¾¿å¤ç”¨
</span></span></span><span class="line"><span class="cl"><span class="s2">		&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">image_set</span> <span class="o">==</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">image_set</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;_annotations.coco.json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">n_cls</span> <span class="o">=</span> <span class="n">n_cls</span> <span class="o">+</span> <span class="mi">1</span>              <span class="c1"># èƒŒæ™¯ä¹Ÿç®—ä¸€ä¸ªå•ç‹¬çš„ç±»åˆ«</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image2id</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">image_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_mapping</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_path</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	å¯¹åº”æ¯ä¸€ä¸ªç±»å’Œç±»id
</span></span></span><span class="line"><span class="cl"><span class="s2">		Return: {1:&#39;flower&#39;, 2:&#39;leaf&#39;}
</span></span></span><span class="line"><span class="cl"><span class="s2">	&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">label2id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mapping</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mapping</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	å¯¹åº”æ¯ä¸€å¼ å›¾ç‰‡çš„åå­—å’Œå¯¹åº”id
</span></span></span><span class="line"><span class="cl"><span class="s2">		Return: {1:&#39;7711724741884_-pic_jpg.rf.b4bfcd10c478314fbeb7f136a5c33c46.jpg&#39;}
</span></span></span><span class="line"><span class="cl"><span class="s2">	&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">image2id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mapping</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mapping</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">	è¯»å–Jsonæ–‡ä»¶ï¼Œè¿™ä¸€éƒ¨åˆ†å¯ä»¥å‚è€ƒä¸€ä¸‹å®˜æ–¹æºç çš„datasets/coco.pyä¸­çš„ConvertCocoPolysToMaskç±»
</span></span></span><span class="line"><span class="cl"><span class="s2">	æœ€ç»ˆè¿”å›çš„targetçš„æ ¼å¼åº”è¯¥æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œåƒè¿™æ ·ï¼š
</span></span></span><span class="line"><span class="cl"><span class="s2">		{&#34;boxes&#34;:[], &#34;labels&#34;:[], &#34;area&#34;:[], &#34;iscrowd&#34;:[], &#34;orig_size&#34;:[], &#34;size&#34;:[]}
</span></span></span><span class="line"><span class="cl"><span class="s2">	å› ä¸ºroboflowç”Ÿæˆçš„jsonæ–‡ä»¶åªæœ‰ä¸€ä¸ªï¼Œç„¶è€Œ__getiten__ä¸­ä¸€æ¬¡åªè¿”å›ä¸€å¼ å›¾å’Œæ ‡ç­¾ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠå„ä¸ªéƒ¨åˆ†éƒ½æ‹†è§£å¼€æ¥
</span></span></span><span class="line"><span class="cl"><span class="s2">	&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">image_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2id</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="n">bboxes</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">iscrowd</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">ann</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">image_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_mapping</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">bboxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">iscrowd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="s1">&#39;iscrowd&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">bboxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># =====================================</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œroboflowç”Ÿæˆçš„æ˜¯ï¼ˆx, y, w, hï¼‰æ ¼å¼çš„boxï¼Œxyä¸ºå·¦ä¸Šè§’çš„åæ ‡</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ä½†æ˜¯å®˜æ–¹æºç çš„è¾“å…¥éœ€è¦çš„æ˜¯å·¦ä¸Šå³ä¸‹ä¸¤ä¸ªç‚¹çš„åæ ‡</span>
</span></span><span class="line"><span class="cl">            <span class="n">tmp</span> <span class="o">=</span> <span class="n">bboxes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">left_corner</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>			
</span></span><span class="line"><span class="cl">            <span class="n">right_corner</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">bboxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">left_corner</span><span class="p">,</span> <span class="n">right_corner</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># =====================================</span>
</span></span><span class="line"><span class="cl">            <span class="n">classes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">iscrowd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">iscrowd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;boxes&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bboxes</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;labels&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;image_id&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;area&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;iscrowd&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iscrowd</span>
</span></span><span class="line"><span class="cl">            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;orig_size&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;size&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">è°ƒç”¨æ•°æ®é›†çš„å…¥å£å‡½æ•°ï¼Œä¹Ÿæ˜¯å‚è€ƒçš„åŸä»£ç ä¸­datasets/coco.pyçš„å†™æ³•
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">other_dataset_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;provided SF path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1"> does not exist&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dataset</span> <span class="o">=</span> <span class="n">SmartFarm</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">make_coco_transforms</span><span class="p">(</span><span class="n">image_set</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dataset</span>
</span></span></code></pre></div><p>å†™å¥½Datasetç±»ä¹‹åï¼Œè¦æ€ä¹ˆå»è°ƒç”¨å‘¢ï¼Ÿæ¥åˆ°datasets/__init__.pyæ–‡ä»¶é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥é€‰æ‹©æ•°æ®é›†çš„ï¼Œæˆ‘ä»¬åŠ ä¸Šè‡ªå·±çš„æ•°æ®é›†é€‰æ‹©å™¨ï¼Œä¸ç”¨ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œåªç”¨åŠ ä¸€ä¸ªifåˆ¤æ–­å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">==</span> <span class="s1">&#39;coco&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">build_coco</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">==</span> <span class="s1">&#39;coco_panoptic&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># to avoid making panopticapi required for coco</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">.coco_panoptic</span> <span class="kn">import</span> <span class="n">build</span> <span class="k">as</span> <span class="n">build_coco_panoptic</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">build_coco_panoptic</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    æˆ‘çš„æ•°æ®é›†åå­—å«sfï¼Œå½“æˆ‘ä¼ å…¥è¿™ä¸ªå‚æ•°çš„æ—¶å€™å®ƒä¼šè‡ªåŠ¨è°ƒç”¨ä¸Šé¢åˆ›å»ºå¥½çš„buildå…¥å£å‡½æ•°åˆ›å»ºSmartFarmçš„æ•°æ®ç±»ï¼š
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">==</span> <span class="s1">&#39;sf&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">.sf</span> <span class="kn">import</span> <span class="n">build</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">build</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dataset </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span><span class="si">}</span><span class="s1"> not supported&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="23-æ•°æ®å¢å¼ºéƒ¨åˆ†">2.3 æ•°æ®å¢å¼ºéƒ¨åˆ†</h2>
<p>å¦‚æœä½ åƒæˆ‘ä¹‹å‰é‚£æ ·å†™æ•°æ®çš„éƒ¨åˆ†ï¼Œé‚£è¿™ä¸€éƒ¨åˆ†ä½ å¯ä»¥<!-- raw HTML omitted --><strong>ç›´æ¥è·³è¿‡ä¸ç”¨ç®¡</strong><!-- raw HTML omitted -->ï¼ŒåŸä»£ç ä¸­çš„æ•°æ®å¢å¼ºå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†å¦‚æœä½ æƒ³è‡ªå·±æ¢æ›´å¤šçš„æ•°æ®å¢å¼ºæ–¹å¼ï¼Œè¿™ä¸€éƒ¨åˆ†æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘è‡ªå·±ä¹Ÿè¸©äº†ä¸å°‘å‘å“ˆå“ˆå“ˆã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£ä¸€ä¸‹åŸä»£ç æ˜¯å¦‚ä½•å®ç°æ•°æ®å¢å¼ºçš„ï¼Œé‡ç‚¹å…³æ³¨datasetsæ–‡ä»¶å¤¹ä¸‹çš„coco.pyå’Œtransforms.pyæ–‡ä»¶ã€‚coco.pyä¸­æœ‰ä¸€ä¸ªmake_coco_transformså‡½æ•°ï¼Œç”¨äºåšæ•°æ®å¢å¼ºï¼Œé‡Œé¢ä½¿ç”¨äº†ç®€å†™Tï¼Œä¸€èˆ¬æ¥è¯´ç¬¬ä¸€ååº”éƒ½æ˜¯Tä¸å°±æ˜¯ä»£è¡¨çš„torchvision.transformsåº“å˜›ï¼Œé‚£å¥½ï¼Œä½ è¢«<!-- raw HTML omitted --><strong>è¯¯å¯¼</strong><!-- raw HTML omitted -->äº†ï¼ï¼</p>
<p>åŸä½œè€…è‡ªå·±é‡å†™äº†transformsåº“ï¼Œåœ¨transforms.pyæ–‡ä»¶é‡Œé¢ï¼Œè¿™ä¸ªTæ˜¯â€œimport datasets.transforms as Tâ€è€Œéâ€œimport torchvision.transforms as Tâ€ã€‚å…¶å®ä¹Ÿä¸å«é‡å†™ï¼Œåªæ˜¯æ·»åŠ äº†å¯¹bounding boxçš„æ•°æ®å¢å¼ºå¤„ç†ï¼Œå› ä¸ºtorchvisionåªå®ç°äº†å¯¹å›¾åƒçš„å¢å¼ºï¼Œä½†å¯¹äºå›¾åƒåˆ†å‰²çš„maskæˆ–è€…ç›®æ ‡æ£€æµ‹çš„bboxéƒ½æ²¡æœ‰å¯¹åº”çš„å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨çš„å‡½æ•°ï¼ˆç°åœ¨å¥½åƒæœ‰äº†ï¼Œä½†æ˜¯ä¸ºäº†èƒ½ç›´æ¥å¤ç”¨åŸä»£ç ï¼Œå·æ‡’å°±ä¸æ”¹äº†ï¼‰ï¼Œå…·ä½“æ€ä¹ˆå®ç°çš„ä½ ä»¬å¯ä»¥ç›´æ¥å»çœ‹transforms.pyçš„æºç ï¼Œå…¶å®çœŸçš„çœŸçš„éå¸¸ç®€å•ã€‚</p>
<p>è¦æ³¨æ„çš„éƒ¨åˆ†åªæœ‰transforms.pyä¸‹çš„Normalizeç±»ï¼Œè¿™ä¹Ÿæ˜¯è®©æˆ‘å¹¡ç„¶é†’æ‚Ÿçš„ä¸€æ®µä»£ç ï¼Œä»å€’æ•°ç¬¬å››è¡Œé‡Œçš„â€œbox_xyxy_to_cxcywhâ€æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<!-- raw HTML omitted -->åŸæ¥å®ƒåœ¨æ•°æ®å¢å¼ºä¹‹å‰æ˜¯(x, y, x, y)çš„æ•°æ®æ ¼å¼è€Œä¸æ˜¯roboflowè‡ªå¸¦çš„(x, y, w, h)å•Šï¼ï¼ï¼Œå¹¶ä¸”çœŸæ­£å–‚å…¥ç½‘ç»œçš„æ ¼å¼æ˜¯(center_x, center_y, w, h)<!-- raw HTML omitted -->ï¼Œæœ‰ç‚¹ç»•ï¼Œä½†æ˜¯å¿…é¡»å¼„æ¸…æ¥šï¼ï¼ä¸ç„¶å°±ä¼šåƒæˆ‘ä¹‹å‰é‚£æ ·lossé£™åˆ°2wå¤šã€‚ã€‚ã€‚</p>
<p>å¹¶ä¸”æœ€åæ¨¡å‹é¢„æµ‹çš„è¾“å‡ºç»“æœä¹Ÿä¼šæ˜¯(center_x, center_y, w, h)ï¼Œå¦‚æœæŠŠå›¾åƒå’Œç›®æ ‡æ£€æµ‹æ¡†ç”»å‡ºæ¥ï¼Œå¾—ä»¥ç›¸åçš„æ–¹å¼æŠŠå®ƒè¿˜åŸã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Normalize</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;boxes&#34;</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">boxes</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s2">&#34;boxes&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">boxes</span> <span class="o">=</span> <span class="n">box_xyxy_to_cxcywh</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="p">[</span><span class="s2">&#34;boxes&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
</span></span></code></pre></div><h1 id="3-å¼€å§‹è®­ç»ƒ">3. å¼€å§‹è®­ç»ƒ</h1>
<h2 id="31-æ¨¡å‹å‚æ•°è®¾ç½®">3.1 æ¨¡å‹å‚æ•°è®¾ç½®</h2>
<p>ç»¼ä¸Šæˆ‘ä»¬å®Œæˆäº†æ•°æ®çš„å¤„ç†éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥å…³æ³¨åˆ°main.pyæ–‡ä»¶ï¼Œå¼€å§‹è¿›è¡Œæ¨¡å‹çš„è®­ç»ƒéƒ¨åˆ†ã€‚åŒå¤§å¤šæ•°æºç ä¸€æ ·ï¼Œä»£ç æ˜¯åœ¨æœåŠ¡å™¨ä¸Šè·‘çš„å› æ­¤é‡‡ç”¨äº†å‘½ä»¤è¡Œå¯åŠ¨çš„æ–¹å¼ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å®ƒå®šä¹‰äº†å¾ˆå¤šå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä»å‘½ä»¤è¡Œé‡Œå‘é€ç»™å®ƒï¼Œåƒè¿™æ ·ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">python -m torch.distributed.launch --nproc_per_node<span class="o">=</span><span class="m">8</span> --use_env main.py --coco_path /path/to/coco  --coco_panoptic_path /path/to/coco_panoptic --dataset_file coco_panoptic --output_dir /output/path/box_model
</span></span></code></pre></div><p>ä½†ç”±äºæˆ‘æ˜¯åœ¨æœ¬åœ°Pycharmä¸Šè·‘çš„ï¼Œä¸ºäº†èƒ½æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘æŠŠè¯¥æœ‰çš„å‚æ•°éƒ½å®šä¹‰åœ¨äº†ä»£ç é‡Œé¢ï¼Œæ¯”å¦‚ä¸‹é¢å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å‚æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_args_parser</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># è®¾ç½®è®­ç»ƒè¶…å‚æ•°</span>
</span></span><span class="line"><span class="cl">	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s1">&#39;Set transformer detector&#39;</span><span class="p">,</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr_backbone&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch_size&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--weight_decay&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epochs&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr_drop&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--clip_max_norm&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;gradient clipping max norm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ•°æ®é›†é€‰æ‹©å™¨ï¼Œè¿™ä¸ªå‚æ•°ä¼šåœ¨datasets/__init__.pyä¸­çš„build_datasetå‡½æ•°ä¸­è°ƒç”¨ï¼Œé€‰æ‹©æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰Datasetç±»</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dataset_file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;sf&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™ä¸ªæ˜¯æˆ‘è‡ªå·±æ–°åŠ çš„ä¸€ä¸ªå‚æ•°ï¼ŒåŸä»£ç åªæä¾›äº†coco_pathï¼Œè¿™æ ·å†™çš„è¯å¯ä»¥åœ¨ä¸æ”¹å˜åŸä»£ç çš„åŸºç¡€ä¸Šé€‰æ‹©æˆ‘ä»¬è‡ªå·±çš„æ•°æ®é›†è·¯å¾„</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--other_dataset_path&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;/Users/shijunshen/Documents/Code/dataset/Smart_Farm_Detection.v1i.coco&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é€‰æ‹©ä½ çš„outputæ–‡ä»¶å¤¹ï¼Œè¿™é‡Œä¼šå­˜å‚¨checkpointå’Œlogæ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output_dir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./output&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path where to save, empty for no saving&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é€‰æ‹©cpuæˆ–è€…cudaï¼Œå› ä¸ºæˆ‘æ˜¯MacOSï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨çš„æ˜¯è‹¹æœçš„ç¡¬ä»¶åŠ é€Ÿmps</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;mps&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;device to use for training / testing&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># åŸä»£ç ä¸­å®šä¹‰çš„æ˜¯100ï¼Œå› ä¸ºé‡‡ç”¨çš„cocoæ•°æ®é›†ï¼Œè¿™é‡Œçš„æ•°å€¼å¯¹åº”çš„æ˜¯æ¨¡å‹ä¼šé¢„æµ‹å‡ºæ¥å¤šå°‘ä¸ªé¢„æµ‹æ¡†ï¼Œç”±äºåœ¨æˆ‘çš„æ•°æ®é›†é‡Œå¤§æ¦‚ä¸€å¼ å›¾æœ‰åå‡ ä¸ªç›®æ ‡ï¼Œå› æ­¤æˆ‘å®šçš„20ã€‚</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_queries&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Number of query slots&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™ä¸ªå‚æ•°ä¼šè°ƒç”¨ä¹‹å‰è®­ç»ƒå¥½çš„checkpointæ–‡ä»¶ï¼Œä½ å¯ä»¥ç›´æ¥ä¸‹è½½å®˜ç½‘é¢„è®­ç»ƒå¥½çš„æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--resume&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./output/checkpoint0599.pth&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;resume from checkpoint&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ====================================================================</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># åŸä»£ç åªæœ‰evalä¸€ä¸ªå‚æ•°ï¼Œpredictæ˜¯æˆ‘è‡ªå·±åŠ ä¸Šçš„ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨trainçš„æ—¶å€™ä¸ç”¨ç®¡å®ƒï¼Œåœ¨æµ‹è¯•å’Œæ¨¡å‹é¢„æµ‹çš„æ—¶å€™å¯ä»¥åœ¨åé¢ç›´æ¥åŠ ä¸Šdefault=Trueï¼Œä¸åŠ Trueå°±æ²¡æœ‰ç”¨ï¼Œè¿™ä¸ªå’Œåœ¨å‘½ä»¤è¡Œé‡ŒåŠ ä¸Š--evalè¿™ä¸ªå‚æ•°ä½œç”¨æ˜¯ä¸€æ ·çš„</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--eval&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--predict&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ====================================================================</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å¤šçº¿ç¨‹ï¼Œæˆ‘çš„cpuæœ‰10ä¸ªæ ¸æˆ‘å°±å¡«äº†10ï¼Œå½±å“ä¸å¤§</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_workers&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parser</span>
</span></span></code></pre></div><p>å…¶å®ƒçš„ä»£ç ä¹Ÿå¾ˆå¸¸è§„ï¼Œå¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Œè¿˜æœ‰ä¸€ä¸ªéƒ¨åˆ†å°±æ˜¯engine.pyï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€æ®µä»£ç ï¼Œåœ¨å®ƒçš„evaluateå‡½æ•°é‡Œé¢ï¼ŒæŠŠcoco_evaluatorç½®ä¸ºNoneï¼Œä¸ç„¶å®ƒå°±ä¼šè°ƒç”¨COCOçš„è¯„ä¼°ä»£ç é‡Œå»äº†ã€‚è®­ç»ƒçš„æ—¶å€™æ¯ä¸€è½®éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å»è¿›è¡Œæ‰“å°ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è§‰å¾—ä½œè€…å†™çš„è¿˜ä¸å¤Ÿå¥½çš„ä¸€ç‚¹ï¼Œå°±æ˜¯åªèƒ½ç”¨ä»–çš„åŸç”Ÿä»£ç å»è®­ç»ƒCOCOæ•°æ®é›†ï¼Œæ²¡æœ‰ç»™ä¸€ä¸ªå®Œå–„çš„æ¥å£è®©æˆ‘ä»¬æ‹¿æ¥å³ç”¨ï¼Œå¿…é¡»å¾—è‡ªå·±æ¥æ”¹æ”¹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">coco_evaluator</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="c1"># coco_evaluator = CocoEvaluator(base_ds, iou_types)</span>
</span></span></code></pre></div><p>åŒæ—¶æˆ‘ä»¬è¿˜è¦æ‰¾åˆ°models/detr.pyä¸‹çš„buildå‡½æ•°ï¼ŒæŠŠå®ƒçš„num_classesæ”¹ä¸ºä½ è‡ªå·±çš„ç±»åˆ«æ•°é‡ï¼Œè¿™ä¸€æ®µå…¶å®å¯ä»¥é‡‡ç”¨ä¼ å‚çš„æ¨¡å¼ä¼ åˆ°æ¨¡å‹ä¸­æ¥ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆä½œè€…ç•™åœ¨è¿™é‡Œåªèƒ½å•ç‹¬æ¥è®¾ç½®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">!=</span> <span class="s1">&#39;coco&#39;</span> <span class="k">else</span> <span class="mi">91</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">==</span> <span class="s2">&#34;coco_panoptic&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for panoptic, we just add a num_classes that is large enough to hold</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># max_obj_id + 1, but the exact value doesn&#39;t really matter</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_classes</span> <span class="o">=</span> <span class="mi">250</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥åªéœ€è¦ç›´æ¥ç‚¹å‡»è¿è¡ŒæŒ‰é’®å°±å¯ä»¥å¼€å§‹è®­ç»ƒæ¨¡å‹å•¦ï¼è®°å¾—&ndash;evalï¼Œå’Œ&ndash;predictä¸è¦è®¾ç½®ä¸ºTrueå–”ã€‚</p>
<h2 id="32-åŠ è½½é¢„è®­ç»ƒæƒé‡ç„¶åå¾®è°ƒ">3.2 åŠ è½½é¢„è®­ç»ƒæƒé‡ç„¶åå¾®è°ƒ</h2>
<p>è¿™ä¸ªéƒ¨åˆ†å¯ä»¥è·³è¿‡ï¼Œå½“ç„¶æˆ‘è¿˜æ˜¯æ›´å»ºè®®å¤§å®¶é‡‡ç”¨è¿™ç§åšæ³•ï¼Œå› ä¸ºåŸä»£ç ä¸­å·²ç»ç»™å‡ºäº†è®­ç»ƒå¥½çš„æƒé‡å•¦ã€‚</p>
<p>åŸä»£ç åœ¨COCOæ•°æ®é›†ä¸Šè®­ç»ƒçš„æƒé‡æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‹¿æ¥åšåˆå§‹åŒ–ï¼Œä½†æ˜¯è¦æ³¨æ„ä½ ä¸‹è½½çš„æƒé‡å¿…é¡»å’Œä½ çš„ç½‘ç»œç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä½ åœ¨main.pyä¸­è®¾ç½®äº†backboneä¸ºresnet50ï¼Œä½ ä¹Ÿè¦ä¸‹è½½å¯¹åº”çš„æƒé‡æ–‡ä»¶ï¼Œå¦‚æœä½ æœ¬èº«å°±ä»€ä¹ˆä¹Ÿæ²¡æ”¹çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥ä¸‹è½½å®ƒçš„ç¬¬ä¸€ä¸ªæƒé‡æ–‡ä»¶ã€‚</p>
<!-- raw HTML omitted -->
<p>ç„¶åæŠŠresumeè®¾ç½®ä¸ºä½ ä¸‹è½½å¥½çš„æƒé‡æ–‡ä»¶è·¯å¾„ï¼Œ==åŒæ—¶ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç‚¹==ï¼Œç”±äºæˆ‘ä»¬ä¿®æ”¹äº†num_queriesä»¥åŠnum_classesï¼Œæ¨¡å‹çš„headéƒ¨åˆ†å·²ç»ä¸ä¸€æ ·äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨main.pyé‡ŒåŠ ä¸Šå‡ æ®µä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load_state_dict_from_url</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">check_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ==============================================================</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># è¿™ä¸€æ®µæ˜¯ä¿®æ”¹äº†çš„ï¼Œå»é™¤å¤šä½™çš„å‚æ•°ï¼Œå¹¶å°†load_state_dictè®¾ç½®ä¸ºstrict=Falseï¼Œè¿™æ ·å®ƒä¾¿ä¼šåªåŠ è½½æ¨¡å‹ç»“æ„ç›¸åŒéƒ¨åˆ†çš„é¢„è®­ç»ƒå‚æ•°</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">][</span><span class="s2">&#34;class_embed.weight&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">][</span><span class="s2">&#34;class_embed.bias&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">del</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&#34;model&#34;</span><span class="p">][</span><span class="s2">&#34;query_embed.weight&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">model_without_ddp</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ==============================================================</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">and</span> <span class="s1">&#39;optimizer&#39;</span> <span class="ow">in</span> <span class="n">checkpoint</span> <span class="ow">and</span> <span class="s1">&#39;lr_scheduler&#39;</span> <span class="ow">in</span> <span class="n">checkpoint</span> <span class="ow">and</span> <span class="s1">&#39;epoch&#39;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;lr_scheduler&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span></span></code></pre></div><h1 id="4-å¯è§†åŒ–æµ‹è¯•ç»“æœ">4. å¯è§†åŒ–æµ‹è¯•ç»“æœ</h1>
<p>è®­ç»ƒä¹‹åæˆ‘ä»¬è‚¯å®šæƒ³æŠŠç»“æœç›´è§‚åœ°æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸ç„¶æ€ä¹ˆå»ç»™è€æ¿äº¤å·®ğŸ¤¡ï¼Œæºç æ²¡æœ‰å®ç°è¿™ä¸ªï¼Œå› æ­¤æˆ‘æ·»åŠ äº†ä¸Šé¢æ‰€è¯´çš„predictå‚æ•°ï¼Œå¹¶ä¸”åœ¨main.pyå’Œengine.pyé‡Œåˆ†åˆ«åŠ å…¥äº†è¿™ä¸¤æ®µï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">main.py
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">eval</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">       <span class="n">test_stats</span><span class="p">,</span> <span class="n">coco_evaluator</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">postprocessors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">data_loader_val</span><span class="p">,</span> <span class="n">base_ds</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="c1"># if args.output_dir:</span>
</span></span><span class="line"><span class="cl">       <span class="c1">#     utils.save_on_master(coco_evaluator.coco_eval[&#34;bbox&#34;].eval, output_dir / &#34;eval.pth&#34;)</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿™ä¸€æ®µæ˜¯æˆ‘åŠ çš„</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">predict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">postprocessors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">data_loader_val</span><span class="p">,</span> <span class="n">base_ds</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">engine.py
</span></span></span><span class="line"><span class="cl"><span class="s2">è¿™ä¸ªåªæ˜¯æˆ‘ç”¨æ¥åšæµ‹è¯•ç”¨çš„ï¼Œå› æ­¤å†™å¾—ä¸æ˜¯å¾ˆå®Œå–„ï¼Œåªå¯è§†åŒ–äº†ç¬¬ä¸€å¼ å›¾åƒ
</span></span></span><span class="line"><span class="cl"><span class="s2">ä½†æ˜¯å…¶ä¸­å¯¹boxçš„è¿˜åŸä½ ä»¬å¯ä»¥å‚è€ƒä¸€ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@torch.no_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">postprocessors</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">base_ds</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">criterion</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">samples</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">tensors</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">img</span> <span class="o">=</span> <span class="n">tensor</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="c1"># åNormalizationï¼Œè¿™ä¸ªmeanå’Œstdæ˜¯ImageNetæ•°æ®é›†ä¸Šåšpretrainæ—¶å€™çš„å¸¸ç”¨å‚æ•°ï¼ŒåŸä»£ç ä¹Ÿç”¨äº†è¿™ä¸¤ä¸ªå€¼ï¼Œå¯ä»¥åœ¨æ•°æ®å¢å¼ºé‚£éƒ¨åˆ†çœ‹åˆ°</span>
</span></span><span class="line"><span class="cl">        <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">img_cv2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>  <span class="c1"># å°†NumPyæ•°ç»„è½¬æ¢ä¸ºOpenCVçš„Matå¯¹è±¡</span>
</span></span><span class="line"><span class="cl">        <span class="n">bbox</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;pred_boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># bbox = targets[0][&#39;boxes&#39;].cpu().numpy()</span>
</span></span><span class="line"><span class="cl">        <span class="n">img_height</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img_cv2</span><span class="o">.</span><span class="n">shape</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># æŠŠï¼ˆcenter_x, center_y, w, hï¼‰çš„æ ¼å¼è½¬æ¢ä¸ºå·¦ä¸Šè§’å’Œå³ä¸‹è§’ä¸¤ä¸ªç‚¹çš„åæ ‡ï¼Œç”¨cv2.rectangleæŠŠå®ƒä»¬ç”»å‡ºæ¥</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">w_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">w_</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cy</span> <span class="o">-</span> <span class="n">h_</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">w_</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">h_</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_cv2</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">img_cv2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
</span></span></code></pre></div><p>åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯è¿™æ ·çš„ï¼Œå› ä¸ºæˆ‘åœ¨num_queriesä¸­è®¾ç½®äº†20ï¼Œæ‰€ä»¥æ¨¡å‹ä¸€å…±é¢„æµ‹äº†20ä¸ªbounding boxï¼Œåé¢ä½ ä»¬ä¹Ÿå¯ä»¥åšå¤„ç†ï¼Œæ¯”å¦‚åªæ˜¾ç¤ºé¢„æµ‹æ¦‚ç‡æœ€é«˜çš„å‰å‡ ä¸ªæ¡†ï¼Œåœ¨æ¨¡å‹é¢„æµ‹ç»“æœçš„å­—å…¸ä¸­ä¸ä»…æœ‰â€˜pred_boxesâ€™ï¼Œä¹Ÿæœ‰â€˜pred_logitsâ€™ï¼Œå¯ä»¥è¿‡æ»¤å‡ºæœ€é«˜æ¦‚ç‡çš„å‡ ä¸ªæ¡†ï¼Œä¸è¿‡è¿™æ ·å·²ç»å¯ä»¥çœ‹å‡ºï¼Œç»“æœè¿˜æ˜¯ä¸é”™çš„å•¦ã€‚</p>
<p><img src="/img/detr_image.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h1 id="5-æ€»ç»“">5. æ€»ç»“</h1>
<p>æ€»çš„æ¥è¯´ï¼ŒDETRè®­ç»ƒçš„æ•ˆç‡è¿˜æ˜¯è›®é«˜çš„ï¼Œæˆ‘åªç”¨äº†15å¼ æ ‡æ³¨å¥½çš„å›¾ç‰‡è¿›è¡Œè®­ç»ƒï¼Œå¹¶ä¸”ä¸‹è½½äº†åŸä»£ç ä¸­åœ¨COCOæ•°æ®é›†ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ç„¶ååœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼Œç”¨Colabä¸Šçš„L4 GPUè®­ç»ƒäº†ååˆ†é’Ÿå·¦å³ï¼Œ600ä¸ªepochä¾¿è¾¾åˆ°äº†è¿™æ ·çš„æ•ˆæœã€‚</p>
<p>æ¬¢è¿å¤§å®¶æé—®ä»¥åŠæŒ‡æ­£ï¼</p>

        
          <div class="blog-tags">
            
              
              <a href="http://localhost:1313/tags/deep-learning/">Deep Learning</a>&nbsp;
            
              
              <a href="http://localhost:1313/tags/computer-vision/">Computer Vision</a>&nbsp;
            
          </div>
        

        

        
          

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="http://localhost:1313/post/2024-03-17-git-basic/" data-toggle="tooltip" data-placement="top" title="GitæŠ€æœ¯">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="http://localhost:1313/post/2024-9-23-rl01/" data-toggle="tooltip" data-placement="top" title="å¼ºåŒ–å­¦ä¹ ä¸­çš„åŸºæœ¬æ¦‚å¿µä»¥åŠé©¬å°”å¯å¤«å†³ç­–">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
      
        <script src="https://giscus.app/client.js"
        data-repo="ashhhi/hugoblogtalks"
        data-repo-id="R_kgDOLgjUJw"
        data-category="Announcements"
        data-category-id="DIC_kwDOLgjUJ84CimSM"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="gruvbox_light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
        </script>
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:shijunshen424@gmail.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/ashhhi" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://open.spotify.com/user/31qjiuhfme47s27qrx6366ruvmjq" title="Spotify">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-spotify fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://telegram.me/ashsjs424" title="Telegram">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-telegram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Ashhhi
            
          

          &nbsp;&bull;&nbsp;&copy;
          2024

          
            &nbsp;&bull;&nbsp;
            <a href="http://localhost:1313/">Ashhhi - æ‚è®°</a>
          
          
            &nbsp;&bull;&nbsp;
            <small class="fas fa-clock"></small>
            <span id="sitetime"></span>
            <script language=javascript>
                function siteTime(){
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth()+1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(2024,3,13,0,0,0);  
                    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
                    var diff = t2-t1;
                    var diffYears = Math.floor(diff/years);
                    var diffDays = Math.floor((diff/days)-diffYears*365);
                    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
                    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
                    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
                    document.getElementById("sitetime").innerHTML="<small>"+diffYears+" y "+diffDays+" d "+diffHours+" h "+diffMinutes+" m "+diffSeconds+" s"+"</small>"; 
                }
                siteTime();
            </script>
          

          &nbsp;&bull;&nbsp;
          <small class="fas fa-users"></small>
          <script async src="/js/busuanzi.pure.mini.js"></script>
          <small>
              <span id="busuanzi_value_site_pv"></span>
          </small>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.134.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="http://localhost:1313/js/main.js"></script>
<script src="http://localhost:1313/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="http://localhost:1313/js/load-photoswipe.js"></script>














    
  </body>
</html>

